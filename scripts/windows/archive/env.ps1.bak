# Hartonomous Hypercube - Windows Environment Setup
# Source this in PowerShell: . .\scripts\windows\env.ps1

$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$ProjectRoot = (Get-Item "$ScriptDir\..\..").FullName

# Load config.env if it exists
$ConfigFile = "$ProjectRoot\scripts\config.env"
if (Test-Path $ConfigFile) {
    Get-Content $ConfigFile | ForEach-Object {
        if ($_ -match '^([^#=]+)=(.*)$') {
            [Environment]::SetEnvironmentVariable($matches[1].Trim(), $matches[2].Trim(), "Process")
        }
    }
}

# Initialize Visual Studio Developer Environment (required for MSVC builds)
if (-not $env:VSCMD_VER) {
    # Find Visual Studio installation using vswhere
    $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
    if (-not (Test-Path $vswhere)) {
        $vswhere = "${env:ProgramFiles}\Microsoft Visual Studio\Installer\vswhere.exe"
    }
    
    $vsPath = $null
    if (Test-Path $vswhere) {
        $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath 2>$null
    }
    
    # Fallback: check common locations
    if (-not $vsPath) {
        $searchPaths = @(
            "D:\Microsoft Visual Studio\18\Community",
            "D:\Microsoft Visual Studio\2022\Community",
            "C:\Program Files\Microsoft Visual Studio\2022\Community",
            "C:\Program Files\Microsoft Visual Studio\2022\Professional",
            "C:\Program Files\Microsoft Visual Studio\2022\Enterprise",
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community",
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional",
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise"
        )
        foreach ($path in $searchPaths) {
            if (Test-Path "$path\Common7\Tools\VsDevCmd.bat") {
                $vsPath = $path
                break
            }
        }
    }
    
    if ($vsPath -and (Test-Path "$vsPath\Common7\Tools\VsDevCmd.bat")) {
        Write-Host "Initializing Visual Studio environment from: $vsPath" -ForegroundColor Yellow
        # Import VS environment variables into PowerShell
        $vsDevCmd = "$vsPath\Common7\Tools\VsDevCmd.bat"
        cmd /c "`"$vsDevCmd`" -arch=amd64 -no_logo && set" | ForEach-Object {
            if ($_ -match '^([^=]+)=(.*)$') {
                [Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
            }
        }
    } else {
        Write-Host "Warning: Visual Studio not found. MSVC builds may fail." -ForegroundColor Red
        Write-Host "Install Visual Studio with C++ workload or set VS path manually." -ForegroundColor Red
    }
}

# Defaults (app-specific, not global PG* vars)
if (-not $env:HC_DB_HOST) { $env:HC_DB_HOST = "localhost" }
if (-not $env:HC_DB_PORT) { $env:HC_DB_PORT = "5432" }
if (-not $env:HC_DB_USER) { $env:HC_DB_USER = "postgres" }
if (-not $env:HC_DB_PASS) { $env:HC_DB_PASS = "postgres" }
if (-not $env:HC_DB_NAME) { $env:HC_DB_NAME = "hypercube" }
if (-not $env:HC_BUILD_TYPE) { $env:HC_BUILD_TYPE = "Release" }
if (-not $env:HC_PARALLEL_JOBS) { $env:HC_PARALLEL_JOBS = "16" }

$env:HC_PROJECT_ROOT = $ProjectRoot
$env:HC_BUILD_DIR = "$ProjectRoot\cpp\build"

# ============================================================================
# Intel oneAPI Runtime (for Intel MKL and OpenMP)
# ============================================================================
$IntelOneAPIBase = "D:\Intel\oneAPI"
if (Test-Path $IntelOneAPIBase) {
    # Add Intel compiler and MKL bin directories to PATH for DLLs
    $env:PATH = "$IntelOneAPIBase\compiler\latest\bin;$IntelOneAPIBase\mkl\latest\bin;$env:PATH"
}

# Build connection string for libpq (used by C++ tools)
$env:HC_CONNINFO = "host=$env:HC_DB_HOST port=$env:HC_DB_PORT dbname=$env:HC_DB_NAME user=$env:HC_DB_USER password=$env:HC_DB_PASS"

function HC-PSQL {
    param([string]$Query)
    $env:PGPASSWORD = $env:HC_DB_PASS
    & psql -h $env:HC_DB_HOST -p $env:HC_DB_PORT -U $env:HC_DB_USER -d $env:HC_DB_NAME -c $Query
    Remove-Item Env:\PGPASSWORD -ErrorAction SilentlyContinue
}

function HC-PSQL-File {
    param([string]$File)
    $env:PGPASSWORD = $env:HC_DB_PASS
    & psql -h $env:HC_DB_HOST -p $env:HC_DB_PORT -U $env:HC_DB_USER -d $env:HC_DB_NAME -f $File
    Remove-Item Env:\PGPASSWORD -ErrorAction SilentlyContinue
}

# Only print banner once per session
if (-not $env:HC_ENV_LOADED) {
    $env:HC_ENV_LOADED = "1"
    Write-Host "Hartonomous environment loaded"
    Write-Host "  Database: $env:HC_DB_NAME @ $env:HC_DB_HOST`:$env:HC_DB_PORT"
    Write-Host "  Project:  $env:HC_PROJECT_ROOT"
}
